<!DOCTYPE html>
<html>

<head>
  <style>
    :root {
      --accent-color: #1967D2;
      --accent-color-alpha30: #1967D24d;
      --accent-color-alpha60: #1967D299;
      --accent-color-alpha40: hsla(215, 79%, 46%, 0.4);
    }

    body {
      font-family: "Inter", sans-serif;
      padding: 2px 4px;
      margin: 0;
      height: 100vh;
      box-sizing: border-box;
      color: var(--figma-color-text);
      background-color: var(--figma-color-bg);
      overflow: hidden; /* Prevent body scroll */
    }

    h4 {
      margin-top: 0;
      color: var(--figma-color-text);
    }

    .search-container {
      position: sticky;
      top: 0;
      z-index: 1;
      background: var(--figma-color-bg);
      padding: 8px 4px;
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
    }

    #components-search-input,
    #icons-search-input {
      flex-grow: 1;
      padding: 10px;
      border: 1.5px solid var(--figma-color-border);
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      outline: none;
      transition: all ease .2s;
    }

    #components-search-input:hover, #components-search-input:focus,
    #icons-search-input:hover, #icons-search-input:focus {
      border-color: var(--figma-color-border-hover);
      outline: none;
    }

    #components-search-input::placeholder,
    #icons-search-input::placeholder {
      color: var(--figma-color-text-tertiary);
    }

    .refresh-button {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 10px;
      padding: 6px 12px;
      cursor: pointer;
      color: var(--figma-color-text);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-button:hover {
      background: var(--figma-color-bg-hover);
    }

    #components-list,
    #icons-list {
      list-style: none;
      padding: 0;
      margin-top: 0;
    }

    /* Style the scrollbar for webkit browsers (Chrome, Safari, etc.) */
    #components-list::-webkit-scrollbar,
    #icons-list::-webkit-scrollbar {
      width: 8px;
    }

    #components-list::-webkit-scrollbar-track,
    #icons-list::-webkit-scrollbar-track {
      background: var(--figma-color-bg);
    }

    #components-list::-webkit-scrollbar-thumb,
    #icons-list::-webkit-scrollbar-thumb {
      background: var(--figma-color-border);
      border-radius: 4px;
    }

    #components-list::-webkit-scrollbar-thumb:hover,
    #icons-list::-webkit-scrollbar-thumb:hover {
      background: var(--figma-color-text-tertiary);
    }

    /* Hide scrollbar for Firefox */
    #components-list,
    #icons-list {
      scrollbar-width: thin;
      scrollbar-color: var(--figma-color-border) transparent;
    }

    .component-item {
      margin: 4px;
    }

    .component-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2px 0;
        border-radius: 4px;
        width: 100%;
        transition: background-color 0.2s;
        cursor: pointer;
    }

    /* Add these new styles */
    .component-left {
        display: flex;
        align-items: center;
        gap: 14px;
    }

	.component-thumbnail {
		width: 32px;
		height: 32px;
		object-fit: contain;
		padding: 10px;
		border-radius: 6px;
		background: hsla(0, 0%, 70%, 0.25);
	}

	.component-thumbnail-icon {
		width: 32px;
		height: 32px;
		object-fit: contain;
		padding: 4px;
		border-radius: 8px;
		background: white;
	}

    .component-content:hover {
	 border-radius: 6px;
      background-color: var(--figma-color-bg-hover);
    }

    .component-name {
      flex-grow: 1;
      font-size: .8rem;
      font-weight: 600;
    }

    .component-actions {
      display: flex;
      gap: 8px;
      margin-right: 10px;
    }

    .action-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.2s;
      color: var(--figma-color-text-secondary);
    }
    #close-dialog {
      margin-top: 10px;
      scale: 2;
    }

    .action-button:hover {
      background-color: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    /* Style for the "No components found" message */
    .component-item li {
      color: var(--figma-color-text-tertiary);
      font-style: italic;
    }

    #status-message,
    #icons-status-message {
      margin-top: 18px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--figma-color-text-secondary);
      padding: 0px 0px 0px 8px;
    }

    /* Radio button styles */
    .source-selector {
      margin-bottom: 16px;
    }

    .source-option {
      margin-right: 12px;
    }

    /* Tab styles */
    .tabs {
      position: sticky;
      top: 0;
      z-index: 2;
      display: flex;
      border-bottom: 1px solid var(--figma-color-border);
      background-color: var(--figma-color-bg);
      padding-top: 8px;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      border-bottom: 2px solid transparent;
      margin-right: 4px;
      font-weight: 500;
    }

    .tab.active {
      color: var(--figma-color-text);
      border-bottom: 2px solid var(--figma-color-text-brand);
      font-weight: 600;
    }

    .tab-container {
      height: calc(100vh - 20px); /* Adjust for body padding */
      display: flex;
      flex-direction: column;
    }

    .tab-content {
      display: none;
      height: 100%;
      overflow-y: auto;
      position: relative;
    }

    .tab-content.active {
      display: block;
    }

    ::-webkit-scrollbar {
      width: 6px; /* Thinner scrollbar */
    }
    /* Style the scrollbar for webkit browsers */
    #component-list::-webkit-scrollbar,
    #icons-list::-webkit-scrollbar {
      width: 6px; /* Thinner scrollbar */
    }

    #component-list::-webkit-scrollbar-track,
    #icons-list::-webkit-scrollbar-track {
      background: transparent; /* Transparent track */
    }

    #component-list::-webkit-scrollbar-thumb,
    #icons-list::-webkit-scrollbar-thumb {
      background: var(--figma-color-text-tertiary);
      border-radius: 6px;
      opacity: 0.5;
    }

  ::-webkit-scrollbar-thumb {
      background: var(--figma-color-text-tertiary);
      border-radius: 6px;
      opacity: 0.5;
    }

    #component-list::-webkit-scrollbar-thumb:hover,
    #icons-list::-webkit-scrollbar-thumb:hover {
      background: var(--figma-color-text-secondary);
    }

    /* For Firefox */
    #component-list,
    #icons-list {
      scrollbar-width: thin;
      scrollbar-color: var(--figma-color-text-tertiary) transparent;
    }

    .icon-swatch {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
      font-family: "Inter", sans-serif;
      font-weight: bold;
      font-size: 12px;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      padding: 8px;
      margin-bottom: 18px;
    }

  .icon-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      padding: 10px 0px 10px 0px;
      margin-bottom: 8px;
      border-radius: 6px;
      transition: background-color 0.2s;
  }

    .icon-item:hover {
      background-color: var(--figma-color-bg-hover);
    }

    .icon-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .icon-name {
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--figma-color-text);
      word-break: break-word;
      max-width: 100%;
    }

    .icon-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .icon-item:hover .icon-actions {
      opacity: 1;
    }

    .component-thumbnail-icon {
      width: 30px;
      height: 30px;
      object-fit: contain;
      padding: 8px;
      border-radius: 8px;
      background: white;
    }

    /* Add styles for the dialog */
    .dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: var(--figma-color-text);
        padding: 0 14px 0 14px;
        box-sizing: border-box;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .dialog.visible {
        opacity: 1;
        visibility: visible;
    }

    .dialog-content {
        background: var(--figma-color-bg);
        padding: 16px 0px;
        width: 100%;
        height: 100%;
        max-height: 100vh;
        transform: translateY(10px);
        transition: transform 0.2s ease;
    }

    .dialog.visible .dialog-content {
        transform: translateY(0);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
    }

    .properties-container {
      margin-bottom: 24px;
    }

    .property-group {
      margin-bottom: 18px;
    }

    .property-label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 8px;
    }

    #create-variant {
        background: var(--figma-color-bg-secondary);
        border: 1px solid var(--figma-color-border);
        border-radius: 10px;
        padding: 8px 16px;
        cursor: pointer;
        color: var(--figma-color-text);
        display: flex;
        font-weight: 600;
        font-size: 16px;
        align-items: center;
        justify-content: center;
        margin-top: 18px;
        transition: all ease .2s;
    }

    #create-variant:hover {
      border: 1px solid var(--accent-color);
      background: var(--accent-color-alpha60);
      color: white;
    }

    .property-select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      cursor: pointer;
      transition: all ease .2s;
    }
    .property-select option {
      font-size: 12px;
    }
    .property-select:hover, .property-select:focus {
      border-color: var(--figma-color-border-hover);
      outline: none;
    }

    /* Add these styles for the property inputs */
    .property-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      box-sizing: border-box;
      transition: all ease .2s;
    }

    .property-input:hover, .property-input:focus {
      border-color: var(--figma-color-border-hover);
      outline: none;
    }

    .property-checkbox {
      margin-right: 4px;
    }

    .property-label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    /* Toggle switch styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 16px;
      margin-right: 8px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--figma-color-bg-disabled);
      transition: .3s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--accent-color);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(16px);
    }

    /* Multi-line text area styles */
    .property-textarea {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 12px;
      box-sizing: border-box;
      font-family: "Inter", sans-serif;
      resize: vertical;
      line-height: 1.4;
      transition: all ease .2s;
    }

    .property-textarea:hover, .property-textarea:focus {
      border-color: var(--figma-color-border-hover);
      outline: none;
    }

    /* Property container with label and input in one row */
    .boolean-property {
      display: flex;
      align-items: center;
    }

    .boolean-property .property-label {
      margin-bottom: 0;
      opacity: 0;
      flex: 1;
    }
  </style>
</head>

<body>
  <div class="tab-container">
    <div class="tabs">
      <div class="tab active" data-tab="components-tab">Components</div>
      <div class="tab" data-tab="icons-tab">Icons</div>
    </div>

    <div id="components-tab" class="tab-content active">
      <p id="status-message">Loading components...</p>
      <div class="search-container">
        <input type="text" id="components-search-input" placeholder="Search components...">
        <button id="refresh-components" class="refresh-button" title="Refresh components">↻</button>
      </div>
      <ul id="components-list"></ul>
    </div>

    <div id="icons-tab" class="tab-content">
      <p id="icons-status-message">Loading icons...</p>
      <div class="search-container" style="margin-bottom: 14px!important;">
        <input type="text" id="icons-search-input" placeholder="Search icons...">
        <button id="refresh-icons" class="refresh-button" title="Refresh icons">↻</button>
      </div>
      <ul id="icons-list"></ul>
    </div>
  </div>

  <!-- Add this new section below the existing content in the body -->
  <div id="component-properties" style="display: none;" class="dialog">
    <div class="dialog-content">
      <div class="dialog-header">
        <h4>Component Properties</h4>
        <button id="close-dialog" class="action-button">×</button>
      </div>
      <div class="properties-container">
        <div id="variant-properties"></div>
        <div id="instance-properties"></div>
      </div>
      <button id="create-variant" class="refresh-button">Create Instance</button>
    </div>
  </div>

  <script>
    // Handle tab switching
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    let componentsData = [];
    let iconsData = [];
    let currentComponentData = null;

    // Set up refresh buttons
    document.getElementById('refresh-components').addEventListener('click', () => {
      document.getElementById('status-message').textContent = "Refreshing components...";
      parent.postMessage({
        pluginMessage: {
          type: 'refresh',
          target: 'components'
        }
      }, '*');
    });

    document.getElementById('refresh-icons').addEventListener('click', () => {
      document.getElementById('icons-status-message').textContent = "Refreshing icons...";
      parent.postMessage({
        pluginMessage: {
          type: 'refresh',
          target: 'icons'
        }
      }, '*');
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');

        // Notify the plugin about tab change
        parent.postMessage({
          pluginMessage: {
            type: 'tab-change',
            tab: tabId
          }
        }, '*');
      });
    });

    // Handle messages from the plugin
    window.onmessage = (event) => {
      const data = event.data.pluginMessage;

      // Handle components data (Tab 1)
      if (data && data.components) {
        componentsData = data.components;
        renderComponents();
      }

      // Handle icons data (Tab 2)
      if (data && data.icons) {
        iconsData = data.icons;
        renderIcons();
      }

      // Handle icon updates
      if (data && data.iconsUpdate) {
        // Update specific icons with thumbnails
        const updateStartIndex = data.iconsUpdateStartIndex || 0;

        for (let i = 0; i < data.iconsUpdate.length; i++) {
          const index = updateStartIndex + i;
          if (index < iconsData.length) {
            // Update the icon data
            iconsData[index] = data.iconsUpdate[i];
          }
        }

        // Re-render the current view
        renderIcons();
      }

      // Handle status messages
      if (data && data.status) {
        document.getElementById('status-message').textContent = data.status;
      }

      if (data && data.iconsStatus) {
        document.getElementById('icons-status-message').textContent = data.iconsStatus;
      }

      // Handle errors
      if (data && data.error) {
        document.getElementById('status-message').textContent = data.error;
        document.getElementById('status-message').style.color = '#FF0000';
      }

      if (data && data.iconsError) {
        document.getElementById('icons-status-message').textContent = data.iconsError;
        document.getElementById('icons-status-message').style.color = '#FF0000';
      }

      // Handle showing component properties
      if (data && data.type === "show-component-properties") {
        const properties = data.properties;
        currentComponentData = properties;
        const variantPropertiesContainer = document.getElementById('variant-properties');
        variantPropertiesContainer.innerHTML = '';

        if (properties && properties.componentProperties) {
          // First, handle variant properties as they should appear at the top
          const variantProps = [];
          const textProps = [];
          const otherProps = [];

          // Sort properties into categories
          Object.entries(properties.componentProperties).forEach(([key, definition]) => {
            // Clean the property name - remove ID suffixes (anything after #)
            const cleanPropertyName = key.split('#')[0];

            // Store both original key and clean name
            const propData = {
              originalKey: key,
              cleanName: cleanPropertyName,
              definition: definition
            };

            // Sort by type
            if (definition.type === 'VARIANT') {
              variantProps.push(propData);
            } else if (definition.type === 'TEXT') {
              textProps.push(propData);
            } else {
              otherProps.push(propData);
            }
          });

          // Combine all properties in the desired order
          const sortedProps = [...variantProps, ...textProps, ...otherProps];

          // Create UI for sorted properties
          sortedProps.forEach(({originalKey, cleanName, definition}) => {
            console.log("Creating input for property:", cleanName, definition);
            const propertyGroup = document.createElement('div');
            propertyGroup.className = 'property-group';

            const label = document.createElement('div');
            label.className = 'property-label';
            label.textContent = cleanName; // Use the clean name without ID suffix
            propertyGroup.appendChild(label);

            // Create different input types based on property type
            if (definition.type === 'VARIANT') {
              const select = document.createElement('select');
              select.className = 'property-select';
              select.dataset.property = originalKey; // Keep original key for data
              select.dataset.type = 'VARIANT';

              // Add options for variant properties
              if (definition.variantOptions) {
                definition.variantOptions.forEach(option => {
                  const optionEl = document.createElement('option');
                  optionEl.value = option;
                  optionEl.textContent = option;
                  if (option === definition.defaultValue) {
                    optionEl.selected = true;
                  }
                  select.appendChild(optionEl);
                });
              }
              propertyGroup.appendChild(select);
            }
            else if (definition.type === 'TEXT') {
              // Check if this is a multi-line text property (usually larger text blocks)
              const isMultiline = originalKey.toLowerCase().includes('description') ||
                                   originalKey.toLowerCase().includes('content') ||
                                   definition.defaultValue?.includes('\n') ||
                                   definition.defaultValue?.length > 80;

              if (isMultiline) {
                const textarea = document.createElement('textarea');
                textarea.className = 'property-textarea';
                textarea.dataset.property = originalKey;
                textarea.dataset.type = 'TEXT';
                textarea.value = definition.defaultValue || '';
                textarea.placeholder = 'Enter text...';
                textarea.rows = 3;

                // Auto-resize logic
                textarea.addEventListener('input', function() {
                  // Reset height to auto to correctly calculate new height
                  this.style.height = 'auto';
                  // Set new height based on scrollHeight with small buffer
                  this.style.height = (this.scrollHeight + 4) + 'px';
                });

                // Trigger resize on initial load
                setTimeout(() => {
                  textarea.style.height = (textarea.scrollHeight + 4) + 'px';
                }, 10);

                propertyGroup.appendChild(textarea);
              } else {
                // Regular single-line text input
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'property-input';
                input.dataset.property = originalKey;
                input.dataset.type = 'TEXT';
                input.value = definition.defaultValue || '';
                input.placeholder = 'Enter text...';
                propertyGroup.appendChild(input);
              }
            }
            else if (definition.type === 'BOOLEAN') {
              // Create a container for the switch and label in one row, replacing the group label
              const booleanContainer = document.createElement('div');
              booleanContainer.className = 'boolean-property';

              // The label comes first in the row, using the property label directly
              const label = document.createElement('div');
              label.className = 'property-label';
              label.textContent = cleanName;
              booleanContainer.appendChild(label);

              // Create the toggle switch
              const toggleSwitch = document.createElement('label');
              toggleSwitch.className = 'toggle-switch';

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.dataset.property = originalKey;
              checkbox.dataset.type = 'BOOLEAN';
              checkbox.checked = definition.defaultValue === 'true';

              const slider = document.createElement('span');
              slider.className = 'toggle-slider';

              toggleSwitch.appendChild(checkbox);
              toggleSwitch.appendChild(slider);
              booleanContainer.appendChild(toggleSwitch);

              // Add the boolean container directly to property group, without a separate label
              propertyGroup.appendChild(booleanContainer);
            }
            else if (definition.type === 'NUMBER') {
              const input = document.createElement('input');
              input.type = 'number';
              input.className = 'property-input';
              input.dataset.property = originalKey; // Keep original key for data
              input.dataset.type = 'NUMBER';
              input.value = definition.defaultValue || 0;
              propertyGroup.appendChild(input);
            }
            else if (definition.type === 'INSTANCE_SWAP') {
              // For advanced users we could provide component selection
              const label = document.createElement('div');
              label.textContent = '(Instance swap not supported in dialog)';
              label.style.fontSize = '10px';
              label.style.fontStyle = 'italic';
              propertyGroup.appendChild(label);
            }

            variantPropertiesContainer.appendChild(propertyGroup);
          });
        }

        // Show the dialog with transition
        document.querySelector('.tab-container').style.display = 'none';
        const dialog = document.getElementById('component-properties');
        dialog.style.display = 'flex';
        // Force a reflow to ensure transition works
        void dialog.offsetWidth;
        dialog.classList.add('visible');
      }

      // Handle create variant button click
      document.getElementById('create-variant').onclick = () => {
        if (!currentComponentData) return;

        // Collect all selected property values
        const properties = {};

        // Get all variants (dropdowns)
        const selects = document.querySelectorAll('.property-select');
        selects.forEach(select => {
          properties[select.dataset.property] = select.value;
        });

        // Get text inputs and textareas
        const textInputs = document.querySelectorAll('.property-input[data-type="TEXT"], .property-textarea');
        textInputs.forEach(input => {
          properties[input.dataset.property] = input.value;
        });

        // Get number inputs
        const numberInputs = document.querySelectorAll('.property-input[data-type="NUMBER"]');
        numberInputs.forEach(input => {
          properties[input.dataset.property] = parseFloat(input.value);
        });

        // Get checkboxes (now inside toggle switches)
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          properties[checkbox.dataset.property] = checkbox.checked;
        });

        // Send message to create instance with selected properties
        parent.postMessage({
          pluginMessage: {
            type: 'create-instance-with-properties',
            componentId: currentComponentData.id,
            properties: properties
          }
        }, '*');

        // Close the dialog
        document.getElementById('close-dialog').click();
      };

      // Handle close dialog button click
      document.getElementById('close-dialog').onclick = () => {
        const dialog = document.getElementById('component-properties');
        dialog.classList.remove('visible');

        // Wait for transition to complete before hiding completely
        setTimeout(() => {
            dialog.style.display = 'none';
            document.querySelector('.tab-container').style.display = 'flex';
        }, 300); // Match the transition duration
      };
    };

    // Update the renderComponents function
    function renderComponents(searchTerm = '') {
      const componentsList = document.getElementById('components-list');
      componentsList.innerHTML = '';
      const componentsSearchInput = document.getElementById('components-search-input');
      searchTerm = searchTerm || componentsSearchInput.value;

      const filteredComponents = componentsData.filter(component =>
        component.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      if (filteredComponents.length === 0) {
        componentsList.innerHTML = '<li style="color: #666; font-style: italic;">No components found</li>';
        return;
      }

      filteredComponents.forEach(component => {
        const item = document.createElement('li');
        item.className = 'component-item';

        // Create container for component name and actions
        const content = document.createElement('div');
        content.className = 'component-content';

        // Add click handler to the content div
        content.onclick = (e) => {
          // Don't trigger if clicking the goto button
          if (!e.target.closest('.action-button')) {
            parent.postMessage({ pluginMessage: { type: 'create-instance', id: component.id } }, '*');
          }
        };

        // Create left container for thumbnail/swatch and name
        const leftContent = document.createElement('div');
        leftContent.className = 'component-left';

        if (component.thumbnail) {
          // Use actual thumbnail
          const thumbnail = document.createElement('img');
          thumbnail.className = 'component-thumbnail';
          thumbnail.src = `data:image/png;base64,${component.thumbnail}`;
          thumbnail.alt = component.name;
          leftContent.appendChild(thumbnail);
        } else {
          // Fallback to color swatch with first letter
          const colorSwatch = document.createElement('div');
          colorSwatch.className = 'component-thumbnail icon-swatch';
          colorSwatch.style.backgroundColor = component.colorHash || '#cccccc';
          if (component.firstChar) {
            colorSwatch.textContent = component.firstChar;
            colorSwatch.style.color = getContrastColor(component.colorHash);
          }
          leftContent.appendChild(colorSwatch);
        }

        // Component name (no longer needs onclick)
        const name = document.createElement('span');
        name.textContent = component.name;
        name.className = 'component-name';
        name.style.cursor = 'pointer';
        leftContent.appendChild(name);

        content.appendChild(leftContent);

        // Actions container
        const actions = document.createElement('div');
        actions.className = 'component-actions';

        // Go to component button
        const gotoBtn = document.createElement('button');
        gotoBtn.innerHTML = '→';
        gotoBtn.title = 'Go to Component';
        gotoBtn.className = 'action-button';
        gotoBtn.onclick = (e) => {
          e.stopPropagation();
          parent.postMessage({ pluginMessage: { type: 'goto-component', id: component.id } }, '*');
        };

        actions.appendChild(gotoBtn);
        content.appendChild(actions);
        item.appendChild(content);
        componentsList.appendChild(item);
      });
    }

    // Icon rendering function
    function renderIcons(searchTerm = '') {
      const iconsList = document.getElementById('icons-list');
      iconsList.className = 'icon-grid';
      iconsList.innerHTML = '';
      const iconsSearchInput = document.getElementById('icons-search-input');
      searchTerm = searchTerm || iconsSearchInput.value;

      const filteredIcons = iconsData.filter(icon =>
        icon.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      if (filteredIcons.length === 0) {
        iconsList.innerHTML = '<li style="color: #666; font-style: italic;">No icons found</li>';
        return;
      }

      filteredIcons.forEach(icon => {
        const item = document.createElement('div');
        item.className = 'icon-item';

        const content = document.createElement('div');
        content.className = 'icon-content';

        if (icon.thumbnail) {
          // Use actual thumbnail
          const thumbnail = document.createElement('img');
          thumbnail.className = 'component-thumbnail-icon';
          thumbnail.src = `data:image/png;base64,${icon.thumbnail}`;
          thumbnail.alt = icon.name;
          content.appendChild(thumbnail);
        } else {
          // Fallback to color swatch with first letter
          const colorSwatch = document.createElement('div');
          colorSwatch.className = 'component-thumbnail icon-swatch';
          colorSwatch.style.backgroundColor = icon.colorHash || '#cccccc';
          if (icon.firstChar) {
            colorSwatch.textContent = icon.firstChar;
            colorSwatch.style.color = getContrastColor(icon.colorHash);
          }
          content.appendChild(colorSwatch);
        }

        // Icon name
        const name = document.createElement('span');
        name.textContent = icon.name;
        name.className = 'icon-name';
        content.appendChild(name);

                // Add click handler to the whole item
        item.onclick = (e) => {
            parent.postMessage({ pluginMessage: { type: 'create-instance', id: icon.id } }, '*');
        };

        item.appendChild(content);
        iconsList.appendChild(item);
      });
    }

    // Function to determine text color based on background color
    function getContrastColor(hexColor) {
      // Remove the # if it's there
      hexColor = hexColor.replace('#', '');

      // Convert to RGB
      const r = parseInt(hexColor.substr(0, 2), 16);
      const g = parseInt(hexColor.substr(2, 2), 16);
      const b = parseInt(hexColor.substr(4, 2), 16);

      // Calculate brightness (YIQ formula)
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;

      // Return white for dark colors, black for light colors
      return brightness > 128 ? '#000000' : '#ffffff';
    }

    // Add search functionality for components
    document.getElementById('components-search-input').addEventListener('input', (e) => {
      renderComponents(e.target.value);
    });

    // Add search functionality for icons
    document.getElementById('icons-search-input').addEventListener('input', (e) => {
      renderIcons(e.target.value);
    });
  </script>
</body>

</html>